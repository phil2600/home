#! /usr/bin/zsh

#############
# FUNCTIONS #
#############

# Create backup (.orig file) and open $EDITOR
backup_and_edit()
{
    if [ $# -ne 1 ]; then
        echo 'What?'
        return 1
    fi
    [[ -r $1 && -f $1 ]] || {
        echo "${0##*/}: $1: no access to that file." >&2
        return 1
    }
    [ ! -r $1.orig ] && cp $1{,.orig}
    $EDITOR $1
}

# Create a timed backup for a given file
bk()      { cp -b ${1} ${1}_`date --iso-8601=m` }

# unrar with nice 19
ur()
{
    if [ "$#" -eq 0 ]; then
        nice -n 19 unrar x *02.rar || nice -n 19 unrar x *.r01
    else
        nice -n 19 unrar x $@
    fi
}

#
tempwatch()
{
    while : ; do
        date "+%H:%M:%S $(sysctl hw.sensors.9|awk '{print $3}')"
        sleep 60
    done
}

# Compile with LaTeX and open the file
viewlatex()
{
    doc=${1%%.tex}
    latex $doc.tex && latex $doc.tex && xdvi $doc.pdf
    rm -f $doc.(dvi|aux|log|toc)
}

# Remove spaces in filenames
removeallspaces()
{
    find . -maxdepth 1 ! -name .| while read name; do
    noname=${name##*/}
    ext=${noname##*.}
    [[ $noname == ${noname// /} ]] && continue
    if [[ $ext == $noname ]]; then
        namecap=${(C)noname}
    else
        noname=${noname%.*}
        namecap=${(C)noname}.$ext
    fi
    namewos=${namecap// /}
    [[ $namewos != $noname ]] &&
    [[ $namecap != $namewos ]] &&
    mv -i $name $namewos
    done
}

#
uptodate()
{
    wget --no-remove-listing $1 && cat .listing && rm .listing index.html
}

# mkdir & cd
mkcd()
{
    test $# -gt 0 || {
	echo 'Usage: mkcd [args] dir (see man mkdir)' >&2
	return 1
    }
    local i=0
    local dir='' # last argument = target directory
    while [ $i -lt $# ]; do
	dir="$1"
	shift
	set dummy "$@" "$dir"
	shift
	i=$((i+1))
    done
    test -d "$dir" || mkdir "$@"
    test -d "$dir" || {
	echo "mkcd: Cannot create directory $dir"
	return 1
    }
    cd "$dir"
}

# List top process runnning
top_process_running()
{
    lsof | awk '{print $1}' | sort | uniq -c | sort -rn | head
}

# ps grep
psg () { ps auxwww | egrep "$1|PID" | grep -v grep }


# cd && ls
cl()      { cd $1 && ls -a }

# Display ASM code prefixed by the C code of the program
disassemble(){ gcc -pipe -S -o - -O -g $* | as -aldh -o /dev/null }

# Test a RegExp
#   zsh with perl-regex - use it e.g. via:
#     regcheck '\s\d\.\d{3}\.\d{3} Euro' ' 1.000.000 Euro'
regcheck() {
    zmodload -i zsh/pcre
    pcre_compile $1 && \
	pcre_match $2 && echo "regex matches" || echo "regex does not match"
}

# list files which have been modified within the last x days
newFiles() { print -l *(m-$1) }

# Print a short status of the user
status() {
    print ""
    print "Date..: "$(date "+%Y-%m-%d %H:%M:%S")""
    print "Shell.: Zsh $ZSH_VERSION (PID = $$, $SHLVL nests)"
    print "Term..: $TTY ($TERM), $BAUD bauds, $COLUMNS x $LINES cars"
    print "Login.: $LOGNAME (UID = $EUID) on $HOST"
    print "System: $(cat /etc/[A-Za-z]*[_-][rv]e[lr]*)"
    print "Uptime:$(uptime)"
    print ""
}

# Copy a directory structure
cp_dir_struct() {
    find * -type d -exec mkdir "$1"\{\} \;
}

# Number of cnx by users
lastuse() {
    last  | grep -v "^$" | awk '{ print $1 }' | sort -nr | uniq -c
}

# ls with tree formating
lsTree() {
    ls -R | grep ":$" | sed -e 's/:$//' -e 's/[^-][^\/]*\//--/g' -e 's/^/   /' -e 's/-/|/'
}

# ls with octal display
lsOctal() {
    ls -l | awk '{k=0;for(i=0;i<=8;i++)k+=((substr($1,i+2,1)~/[rwx]/)*2^(8-i));if(k)printf("%0o ",k);print}'
}

## shitty fct
give_random_pie()
{
    fB_src="/home/phil/utils/freeB_machines"
    fB_nb=$(cat $fB_src | wc -l)
    rdm_host_nb=$[ ( $RANDOM % ${fB_nb} ) ]
    rdm_host=$(cat ${fB_src} | head -n $rdm_host_nb |tail -1)
    echo "$rdm_host"
}
cpie()
{
    host=`give_random_pie`
    echo "ssh on $host"

    ssh faure_p@ssh.epita.fr -t ssh $host
}
cass()
{
    ssh faure_p@ssh.epita.fr -t ssh acu.epita.fr
}

# Convert epoch date to a human readable date
epoch2real(){
    perl -le 'print scalar localtime ${1}'
}

# display dir size ASC
topmax(){
    du --max-depth=1 | sort -r -n | awk '{split("k m g",v); s=1; while($1>1024){$1/=1024; s++} print int($1)" "v[s]"\t"$2}'
}

# display dir size ASC | head
topten(){
    topmax | head -10
}

sr()
{
    ssh root@${1}
}
runsr(){
    for i in apl sh lisp caml ruby ada php java asp; echo $i && ssh root@${i} -t $1 && echo
}

# test if netsoul is running on clients
test_ns(){
    {
	for i in apl sh lisp caml ruby ada php java asp; \
	    echo $i && \
	    ssh root@${i} -t 'echo -n "local: " && \
who | grep -v pts | cut -d" " -f1 | sort && echo -n "netsoul: " && \
netstat -lapute --inet | grep ns | grep netsoul | sed "s/ESTABLISHED//" |tr -s " " | cut -d" " -f6' && \
	    echo
    } 2> /dev/null
}

# ls more
lm() { ls -la "$@" | more}

# Mount a temporary ram partition
mntOnRam() {
    if [ $# -ne 2 ]; then
	echo "Usage: mountPoint size"
	return 1
    fi
    sudo mount -t tmpfs tmpfs "$1" -o size=$2m
}

# display typedefs, structs, unions and functions provided by a header file
dispHeaderInfos() {
    cpp "$i" | grep -v '^#' | grep -v '^$' | less
}

# Given process ID print its environment variables
dispEnvVar() {
    sudo sed 's/\o0/\n/g' /proc/$1/environ
}


# Graph of connections for each hosts.
graphCnx() {
    netstat -an | grep ESTABLISHED | awk '{print $5}' | awk -F: '{print $1}' | sort | uniq -c | awk '{ printf("%s\t%s\t",$2,$1) ; for (i = 0; i < $1; i++) {printf("*")}; print "" }'
}

# Displays the attempted user name, ip address, and time of SSH failed logins on Debian machines
dispErrorsOnSSH() {
awk '/sshd/ && /Failed/ {gsub(/invalid user/,""); printf "%-12s %-16s %s-%s-%s\n", $9, $11, $1, $2, $3}' /var/log/auth.log
}


# Display fibonacci numbers
fibo() {
    seq 50| awk 'BEGIN {a=1; b=1} {print a; c=a+b; a=b; b=c}'
}

###########
#  ALIAS  #
###########
alias gmake="gmake --no-print-directory"
alias rm='rm -i'

alias sl="ssh root@localhost"
alias zl="xscreensaver -nosplash & xscreensaver-command -lock"
alias news="emacs -f gnus"

alias web="firefox &!"
alias gh="echo 'corrected gh to fg'; fg"
alias diff='diff -u'
alias grep='grep --color=auto'
alias finger='MALLOC_OPTIONS='' finger'

alias psa='ps aux'
alias psu='ps  ux'

alias df='df -P'
alias dfk='df -PTak'
alias dfm='df -PTam'
alias dfh='df -PTah'
alias dfi='df -PTai'

alias ds='dig +noauthority +noadditional +noqr +nostats +noidentify +nocmd +noquestion +nocomments'
alias firefox_destroyer='ps aux|grep [f]irefox|awk '{ print $2}'|xargs kill -9'

alias filldisk='watch -n 1 df'
alias topfiles="watch --differences -n 5 'df; ls -FlAt;'"
alias toptenprocess='ps aux | sort -nk +4 | tail'

# Xterm resizing-fu.
# Based on http://svn.kitenet.net/trunk/home-full/.zshrc?rev=11710&view=log (by Joey Hess)
alias hide='echo -en "\033]50;nil2\007"'
alias tiny='echo -en "\033]50;-misc-fixed-medium-r-normal-*-*-80-*-*-c-*-iso8859-15\007"'
alias small='echo -en "\033]50;6x10\007"'
alias medium='echo -en "\033]50;-misc-fixed-medium-r-normal--13-120-75-75-c-80-iso8859-15\007"'
alias default='echo -e "\033]50;-misc-fixed-medium-r-normal-*-*-140-*-*-c-*-iso8859-15\007"'
alias large='echo -en "\033]50;-misc-fixed-medium-r-normal-*-*-150-*-*-c-*-iso8859-15\007"'
alias huge='echo -en "\033]50;-misc-fixed-medium-r-normal-*-*-210-*-*-c-*-iso8859-15\007"'
alias smartfont='echo -en "\033]50;-artwiz-smoothansi-*-*-*-*-*-*-*-*-*-*-*-*\007"'
alias semifont='echo -en "\033]50;-misc-fixed-medium-r-semicondensed-*-*-120-*-*-*-*-iso8859-15\007"'

########
## LS ##
alias l="$lsbin $LS_OPTIONS"
alias ls="$lsbin $LS_OPTIONS"
alias ll="$lsbin $LS_OPTIONS -l"
alias la="$lsbin $LS_OPTIONS -la"

# List only directories and symbolic
# links that point to directories
alias lsd='ls -ld *(-/DN)'

# List only file beginning with "."
alias lsa='ls -ld .*'
alias lstoday='ls *(m-1)'
alias lsempty='ls -ld **/*(/^F)'

# world-{readable,writable,executable} files
alias lsw='ls -ld *(R,W,X.^ND/)'
# display the biggest files
alias lsbig="ls -flh *(.OL[1,10])"
# only show directories
alias lsd='ls -d *(/)'
# only show empty directories
alias lse='ls -d *(/^F)'
# display the newest files
alias lsnew="ls -rl *(D.om[1,10])"
# display the oldest files
alias lsold="ls -rtlh *(D.om[1,10])"
# display the smallest files
alias lssmall="ls -Srl *(.oL[1,10])"


## BROKEN
###########
#
#cdiff()   { diff -crd "$*" | egrep -v "^Only in |^Binary files " }

# Display a block of text with AWK
# awk '/start_pattern/,/stop_pattern/' file.txt
## dmidecode | awk '/Battery/,/^$/'